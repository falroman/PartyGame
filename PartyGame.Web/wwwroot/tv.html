<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PartyGame - TV Host</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        /* Lock toggle styles */
        .lock-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-color);
            border-radius: 12px;
            margin-top: 16px;
        }
        
        .lock-toggle-switch {
            position: relative;
            width: 52px;
            height: 28px;
            background: #ccc;
            border-radius: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .lock-toggle-switch.locked {
            background: var(--warning-color);
        }
        
        .lock-toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .lock-toggle-switch.locked::after {
            transform: translateX(24px);
        }
        
        .lock-toggle-label {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .lock-toggle-label .icon {
            font-size: 1.25rem;
        }
        
        .lock-status {
            font-size: 0.875rem;
            color: var(--text-light);
        }
        
        .lock-status.locked {
            color: var(--warning-color);
        }
        
        /* Game Status Overlay */
        .game-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .game-overlay.visible {
            display: flex;
        }
        
        .game-overlay-content {
            text-align: center;
            color: white;
        }
        
        .game-overlay-icon {
            font-size: 4rem;
            margin-bottom: 24px;
        }
        
        .game-overlay-title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 16px;
        }
        
        .game-overlay-subtitle {
            font-size: 1.25rem;
            opacity: 0.8;
        }

        /* Game Status Card */
        .game-status-card {
            display: none;
            background: var(--success-color);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            margin-bottom: 16px;
        }
        
        .game-status-card.visible {
            display: block;
        }

        /* DEV Panel styles */
        .dev-panel {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid #f97316;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            display: none;
        }

        .dev-panel.visible {
            display: block;
        }

        .dev-panel-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .dev-badge {
            background: #f97316;
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
        }

        .dev-panel-title {
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .dev-panel-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .dev-panel button {
            background: rgba(255,255,255,0.15);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 8px 14px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .dev-panel button:hover {
            background: rgba(255,255,255,0.25);
            border-color: rgba(255,255,255,0.4);
        }

        .dev-panel button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .dev-panel .status-text {
            color: rgba(255,255,255,0.8);
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="tv-layout">
        <!-- Main Content -->
        <div class="tv-main">
            <div class="tv-header">
                <h1>üéÆ PartyGame</h1>
                <p id="headerSubtitle">Scan the QR code or enter the room code to join!</p>
            </div>

            <!-- Connection Status -->
            <div id="connectionStatus" class="status status-connecting" style="align-self: flex-start; margin-bottom: 16px;">
                <span class="status-dot"></span>
                <span id="statusText">Connecting...</span>
            </div>

            <!-- DEV Panel for Bots -->
            <div id="devPanel" class="dev-panel">
                <div class="dev-panel-header">
                    <span class="dev-badge">DEV</span>
                    <span class="dev-panel-title">Server-side Bots (Autoplay)</span>
                </div>
                <div class="dev-panel-controls">
                    <button id="addBotsBtn">ü§ñ Add Bots</button>
                    <button id="startAutoplayBtn">‚ñ∂Ô∏è Start Autoplay</button>
                    <button id="stopAutoplayBtn">‚èπÔ∏è Stop Autoplay</button>
                </div>
                <div class="status-text" id="autoplayStatus">Autoplay: stopped ¬∑ Bots: 0</div>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="error-message card"></div>

            <!-- Loading State -->
            <div id="loadingState" class="card" style="text-align: center; padding: 60px;">
                <div class="spinner" style="margin: 0 auto 20px;"></div>
                <p>Creating room...</p>
            </div>

            <!-- Room Info Card -->
            <div id="roomCard" class="card" style="display: none;">
                <div style="text-align: center;">
                    <p style="color: var(--text-light); margin-bottom: 8px;">ROOM CODE</p>
                    <div class="room-code" id="roomCode">----</div>
                    <p style="color: var(--text-light);">
                        Join at: <strong id="joinUrl"></strong>
                    </p>
                </div>
                
                <!-- Room Lock Toggle -->
                <div class="lock-toggle">
                    <div id="lockSwitch" class="lock-toggle-switch" onclick="toggleRoomLock()"></div>
                    <div>
                        <div class="lock-toggle-label">
                            <span class="icon" id="lockIcon">üîì</span>
                            <span id="lockLabel">Room Open</span>
                        </div>
                        <div id="lockStatus" class="lock-status">New players can join</div>
                    </div>
                </div>
            </div>

            <!-- QR Code Card -->
            <div id="qrCard" class="card qr-container" style="display: none;">
                <div class="qr-code">
                    <img id="qrCodeImage" alt="QR Code" width="200" height="200">
                </div>
                <p class="qr-hint">Scan with your phone camera to join</p>
            </div>

            <!-- Game Status Card (shown when game is in progress) -->
            <div id="gameStatusCard" class="game-status-card">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 1.5rem;">üéØ</span>
                    <div>
                        <div style="font-weight: bold;">Game In Progress</div>
                        <div style="opacity: 0.9; font-size: 0.875rem;">
                            <span id="gameTypeDisplay">Quiz</span> - <span id="gamePhaseDisplay">Starting</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar: Player List -->
        <div class="tv-sidebar">
            <div class="card" style="flex: 1; display: flex; flex-direction: column;">
                <h2 style="margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between;">
                    Players
                    <span id="playerCount" style="background: var(--bg-color); padding: 4px 12px; border-radius: 20px; font-size: 0.875rem;">0/8</span>
                </h2>

                <!-- Empty State -->
                <div id="emptyState" class="empty-state">
                    <div class="empty-state-icon">üë•</div>
                    <p class="empty-state-text">Waiting for players to join...</p>
                </div>

                <!-- Player List -->
                <ul id="playerList" class="player-list" style="display: none;"></ul>

                <!-- Start Game Button -->
                <div id="startGameContainer" style="margin-top: auto; padding-top: 20px;">
                    <button id="startGameBtn" class="btn btn-success btn-large" style="width: 100%;" disabled>
                        Start Game
                    </button>
                    <p id="startGameHint" style="text-align: center; margin-top: 8px; color: var(--text-light); font-size: 0.875rem;">
                        Need at least 2 players to start
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Starting Overlay -->
    <div id="gameOverlay" class="game-overlay">
        <div class="game-overlay-content">
            <div class="game-overlay-icon">üéÆ</div>
            <div class="game-overlay-title">Game Starting!</div>
            <div class="game-overlay-subtitle">Get ready, <span id="overlayPlayerCount">0</span> players...</div>
        </div>
    </div>

    <!-- SignalR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script src="/js/config.js"></script>
    <script src="/js/game-client.js"></script>
    <script>
        // Get server URL from config
        const SERVER_URL = GameConfig.getServerUrl();
        console.log('Using Server URL:', SERVER_URL || '(same origin)');
        
        // Check for room code in URL (for returning from game)
        const urlParams = new URLSearchParams(window.location.search);
        const existingRoomCode = urlParams.get('room');
        
        // DOM Elements
        const connectionStatus = document.getElementById('connectionStatus');
        const statusText = document.getElementById('statusText');
        const errorMessage = document.getElementById('errorMessage');
        const loadingState = document.getElementById('loadingState');
        const roomCard = document.getElementById('roomCard');
        const qrCard = document.getElementById('qrCard');
        const roomCodeEl = document.getElementById('roomCode');
        const joinUrlEl = document.getElementById('joinUrl');
        const qrCodeImage = document.getElementById('qrCodeImage');
        const playerCount = document.getElementById('playerCount');
        const emptyState = document.getElementById('emptyState');
        const playerList = document.getElementById('playerList');
        const startGameBtn = document.getElementById('startGameBtn');
        const lockSwitch = document.getElementById('lockSwitch');
        const lockIcon = document.getElementById('lockIcon');
        const lockLabel = document.getElementById('lockLabel');
        const lockStatusEl = document.getElementById('lockStatus');
        const gameStatusCard = document.getElementById('gameStatusCard');
        const gameTypeDisplay = document.getElementById('gameTypeDisplay');
        const gamePhaseDisplay = document.getElementById('gamePhaseDisplay');
        const headerSubtitle = document.getElementById('headerSubtitle');
        const gameOverlay = document.getElementById('gameOverlay');
        const overlayPlayerCount = document.getElementById('overlayPlayerCount');
        const startGameContainer = document.getElementById('startGameContainer');
        const startGameHint = document.getElementById('startGameHint');
        
        // DEV Panel elements
        const devPanel = document.getElementById('devPanel');
        const addBotsBtn = document.getElementById('addBotsBtn');
        const startAutoplayBtn = document.getElementById('startAutoplayBtn');
        const stopAutoplayBtn = document.getElementById('stopAutoplayBtn');
        const autoplayStatusEl = document.getElementById('autoplayStatus');

        // Game client
        const client = new GameClient(SERVER_URL);
        let currentRoomCode = null;
        let isRoomLocked = false;
        let currentRoomStatus = 'Lobby'; // Lobby, InGame, Finished

        // Initialize
        async function init() {
            try {
                // Set up callbacks
                client.on('onConnected', onConnected);
                client.on('onDisconnected', onDisconnected);
                client.on('onReconnecting', onReconnecting);
                client.on('onLobbyUpdated', onLobbyUpdated);
                client.on('onGameStarted', onGameStarted);
                client.on('onAutoplayStatusUpdated', onAutoplayStatusUpdated);
                client.on('onError', onError);

                // Connect to SignalR
                await client.connect();

                // Either rejoin existing room or create new
                if (existingRoomCode) {
                    await rejoinExistingRoom(existingRoomCode);
                } else {
                    await createAndJoinRoom();
                }
                
                // Configure DEV panel
                await configureDevPanel();

            } catch (error) {
                console.error('Initialization failed:', error);
                showError('Failed to initialize. Please refresh the page.');
            }
        }

        async function rejoinExistingRoom(roomCode) {
            try {
                // Update loading message
                loadingState.querySelector('p').textContent = 'Reconnecting to room...';
                
                // Check if room still exists
                const roomState = await GameUtils.getRoomState(SERVER_URL, roomCode);
                
                if (!roomState) {
                    // Room doesn't exist anymore, create a new one
                    console.log('Room not found, creating new room');
                    loadingState.querySelector('p').textContent = 'Creating new room...';
                    await createAndJoinRoom();
                    return;
                }
                
                currentRoomCode = roomCode;
                
                // Register as host via SignalR
                await client.registerHost(currentRoomCode);
                
                // Update UI
                showRoomInfo(currentRoomCode);
                
                console.log('Rejoined existing room:', roomCode);

            } catch (error) {
                console.error('Failed to rejoin room:', error);
                // Fallback to creating a new room
                await createAndJoinRoom();
            }
        }

        async function createAndJoinRoom() {
            try {
                // Create room via REST API
                const roomData = await GameUtils.createRoom(SERVER_URL);
                currentRoomCode = roomData.roomCode;

                // Register as host via SignalR
                await client.registerHost(currentRoomCode);

                // Update UI
                showRoomInfo(currentRoomCode);

            } catch (error) {
                console.error('Failed to create room:', error);
                showError('Failed to create room. Please refresh the page.');
            }
        }

        function showRoomInfo(code) {
            loadingState.style.display = 'none';
            roomCard.style.display = 'block';
            qrCard.style.display = 'flex';

            roomCodeEl.textContent = code;
            
            // Join URL uses the current origin (works for both localhost and LAN)
            const joinUrl = `${GameConfig.getJoinBaseUrl()}/join/${code}`;
            joinUrlEl.textContent = joinUrl;
            
            // Generate QR code
            qrCodeImage.src = GameUtils.getQRCodeUrl(joinUrl, 200);
        }

        function updateLockUI(locked) {
            isRoomLocked = locked;
            
            if (locked) {
                lockSwitch.classList.add('locked');
                lockIcon.textContent = 'üîí';
                lockLabel.textContent = 'Room Locked';
                lockStatusEl.textContent = 'No new players can join';
                lockStatusEl.classList.add('locked');
            } else {
                lockSwitch.classList.remove('locked');
                lockIcon.textContent = 'üîì';
                lockLabel.textContent = 'Room Open';
                lockStatusEl.textContent = 'New players can join';
                lockStatusEl.classList.remove('locked');
            }
        }

        async function toggleRoomLock() {
            try {
                await client.setRoomLocked(!isRoomLocked);
            } catch (error) {
                console.error('Failed to toggle room lock:', error);
                showError('Failed to change room lock state.');
            }
        }

        function onConnected() {
            connectionStatus.className = 'status status-connected';
            statusText.textContent = 'Connected';
        }

        function onDisconnected() {
            connectionStatus.className = 'status status-disconnected';
            statusText.textContent = 'Disconnected';
        }

        function onReconnecting() {
            connectionStatus.className = 'status status-connecting';
            statusText.textContent = 'Reconnecting...';
        }

        function onLobbyUpdated(roomState) {
            console.log('Lobby updated:', roomState);
            
            const players = roomState.players || [];
            const maxPlayers = 8;

            // Update player count
            playerCount.textContent = `${players.length}/${maxPlayers}`;

            // Update lock state
            updateLockUI(roomState.isLocked);

            // Update room status (can be string "Lobby" or int 0)
            currentRoomStatus = roomState.status;
            updateGameStatusUI(roomState);

            // Update player list
            if (players.length === 0) {
                emptyState.style.display = 'block';
                playerList.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                playerList.style.display = 'block';
                
                playerList.innerHTML = players.map(player => `
                    <li class="player-item fade-in">
                        <div class="player-info">
                            <div class="player-avatar">${GameUtils.getInitials(player.displayName)}</div>
                            <div>
                                <div class="player-name">${escapeHtml(player.displayName)}</div>
                                <div class="player-status ${player.isConnected ? 'connected' : 'disconnected'}">
                                    ${player.isConnected ? '‚óè Connected' : '‚óã Disconnected'}
                                </div>
                            </div>
                        </div>
                    </li>
                `).join('');
            }

            // Enable/disable start button based on player count and game status
            // Status can be string "Lobby" or int 0
            const isLobby = currentRoomStatus === 'Lobby' || currentRoomStatus === 0;
            const canStart = players.length >= 2 && isLobby;
            startGameBtn.disabled = !canStart;
            
            // Update hint text
            if (!isLobby) {
                startGameHint.textContent = 'Game is in progress';
            } else if (players.length < 2) {
                startGameHint.textContent = 'Need at least 2 players to start';
            } else {
                startGameHint.textContent = 'Ready to start!';
            }

            // Hide error on successful update
            hideError();
        }

        function onGameStarted(gameSession) {
            console.log('Game started:', gameSession);
            
            // Show overlay briefly
            overlayPlayerCount.textContent = playerCount.textContent.split('/')[0];
            gameOverlay.classList.add('visible');
            
            // Navigate to quiz TV view after short delay
            if (gameSession.gameType === 'Quiz') {
                setTimeout(() => {
                    window.location.href = `/quiz-tv.html?room=${currentRoomCode}`;
                }, 2000);
            }
        }

        function updateGameStatusUI(roomState) {
            if (roomState.status === 'InGame' || roomState.status === 1) {
                // Show game status
                gameStatusCard.classList.add('visible');
                headerSubtitle.textContent = 'Game in progress!';
                
                // Hide start game container during game
                startGameContainer.style.display = 'none';
                
                // Update game info if available
                if (roomState.currentGame) {
                    gameTypeDisplay.textContent = roomState.currentGame.gameType || 'Quiz';
                    gamePhaseDisplay.textContent = roomState.currentGame.phase || 'Starting';
                }
            } else {
                // Hide game status, show normal lobby
                gameStatusCard.classList.remove('visible');
                headerSubtitle.textContent = 'Scan the QR code or enter the room code to join!';
                startGameContainer.style.display = 'block';
            }
        }
        
        // DEV Panel functions
        async function configureDevPanel() {
            try {
                const response = await fetch(`${SERVER_URL}/health`);
                const data = await response.json();
                if (data?.environment === 'Development') {
                    devPanel.classList.add('visible');
                    setupDevPanelListeners();
                }
            } catch (error) {
                console.warn('DEV panel check failed:', error);
            }
        }
        
        function setupDevPanelListeners() {
            addBotsBtn.addEventListener('click', async () => {
                try {
                    addBotsBtn.disabled = true;
                    await client.addBots();
                } catch (error) {
                    console.error('Failed to add bots:', error);
                    showError('Failed to add bots: ' + (error.message || 'Unknown error'));
                } finally {
                    addBotsBtn.disabled = false;
                }
            });

            startAutoplayBtn.addEventListener('click', async () => {
                try {
                    startAutoplayBtn.disabled = true;
                    await client.startAutoplay();
                } catch (error) {
                    console.error('Failed to start autoplay:', error);
                    showError('Failed to start autoplay: ' + (error.message || 'Unknown error'));
                } finally {
                    startAutoplayBtn.disabled = false;
                }
            });

            stopAutoplayBtn.addEventListener('click', async () => {
                try {
                    stopAutoplayBtn.disabled = true;
                    await client.stopAutoplay();
                } catch (error) {
                    console.error('Failed to stop autoplay:', error);
                    showError('Failed to stop autoplay: ' + (error.message || 'Unknown error'));
                } finally {
                    stopAutoplayBtn.disabled = false;
                }
            });
        }
        
        function onAutoplayStatusUpdated(status) {
            if (!status || !autoplayStatusEl) return;
            const running = status.running ? 'running' : 'stopped';
            autoplayStatusEl.textContent = `Autoplay: ${running} ¬∑ Bots: ${status.botCount ?? 0}`;
        }

        // Start game button click handler
        startGameBtn.addEventListener('click', async () => {
            if (startGameBtn.disabled) return;
            
            try {
                startGameBtn.disabled = true;
                startGameBtn.textContent = 'Starting...';
                
                await client.startGame('Quiz');
                
            } catch (error) {
                console.error('Failed to start game:', error);
                showError('Failed to start game: ' + (error.message || 'Unknown error'));
                startGameBtn.disabled = false;
                startGameBtn.textContent = 'Start Game';
            }
        });

        function onError(error) {
            showError(GameUtils.formatError(error));
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('visible');
        }

        function hideError() {
            errorMessage.classList.remove('visible');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
