<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PartyGame - Join</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        /* Game In Progress styles */
        .game-active-card {
            text-align: center;
            display: none;
        }
        
        .game-active-card.visible {
            display: block;
        }
        
        .game-active-icon {
            font-size: 4rem;
            margin-bottom: 16px;
        }
        
        .game-active-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .game-active-subtitle {
            color: var(--text-light);
            margin-bottom: 24px;
        }
        
        .game-phase-badge {
            display: inline-block;
            background: var(--success-color);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
        }

        /* Avatar Grid Styles */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 8px;
        }

        .avatar-option {
            aspect-ratio: 1;
            border: 3px solid transparent;
            border-radius: 12px;
            background: var(--bg-color);
            cursor: pointer;
            transition: all 0.2s ease;
            overflow: hidden;
            position: relative;
        }

        .avatar-option:hover {
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        .avatar-option.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-color);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }

        .avatar-option img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .avatar-loading {
            grid-column: 1 / -1;
            text-align: center;
            padding: 24px;
            color: var(--text-light);
        }

        .avatar-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        /* Avatar Upload Styles */
        .upload-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--bg-color);
        }

        .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .upload-btn {
            border: 2px dashed #667eea;
            color: #667eea;
            background-color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            width: 100%;
        }

        .upload-btn:hover {
            background-color: #f8f9ff;
            border-color: #5568d3;
        }

        .upload-btn-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }

        .upload-preview {
            margin-top: 12px;
            text-align: center;
            display: none;
        }

        .upload-preview.visible {
            display: block;
        }

        .upload-preview img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-color);
        }

        .upload-preview-text {
            margin-top: 8px;
            font-size: 0.75rem;
            color: var(--success-color);
            font-weight: 600;
        }

        .upload-hint {
            margin-top: 8px;
            font-size: 0.75rem;
            color: var(--text-light);
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="phone-layout">
        <div class="card phone-card">
            <h1 style="text-align: center; margin-bottom: 8px;">ðŸŽ® PartyGame</h1>
            <p style="text-align: center; color: var(--text-light); margin-bottom: 24px;">Join the fun!</p>

            <!-- Connection Status -->
            <div id="connectionStatus" class="status status-connecting" style="margin-bottom: 16px;">
                <span class="status-dot"></span>
                <span id="statusText">Connecting...</span>
            </div>

            <!-- Debug Info (helpful for troubleshooting) -->
            <div id="debugInfo" style="font-size: 0.75rem; color: var(--text-light); margin-bottom: 16px; padding: 8px; background: var(--bg-color); border-radius: 4px;">
                <div>Server: <span id="debugServerUrl">-</span></div>
                <div>Status: <span id="debugStatus">Loading scripts...</span></div>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="error-message"></div>

            <!-- Join Form -->
            <form id="joinForm">
                <div class="input-group">
                    <label for="roomCode">Room Code</label>
                    <input 
                        type="text" 
                        id="roomCode" 
                        class="input input-large" 
                        maxlength="4" 
                        placeholder="ABCD"
                        autocomplete="off"
                        autocapitalize="characters"
                        required
                    >
                </div>

                <div class="input-group">
                    <label for="displayName">Your Name</label>
                    <input 
                        type="text" 
                        id="displayName" 
                        class="input" 
                        maxlength="20" 
                        placeholder="Enter your name"
                        autocomplete="off"
                        required
                    >
                </div>

                <!-- Avatar Selection -->
                <div class="input-group">
                    <label>Choose Your Avatar</label>
                    <div id="avatarGrid" class="avatar-grid">
                        <!-- Avatars will be loaded here -->
                        <div class="avatar-loading">Loading avatars...</div>
                    </div>
                    
                    <!-- Upload section -->
                    <div class="upload-section">
                        <div class="upload-btn-wrapper">
                            <button type="button" class="upload-btn">
                                <span>ðŸ“¤</span>
                                <span>Upload Your Own Photo</span>
                            </button>
                            <input type="file" id="avatarUpload" accept="image/*" />
                        </div>
                        <div id="uploadPreview" class="upload-preview">
                            <img id="uploadPreviewImg" src="" alt="Preview">
                            <div class="upload-preview-text">âœ“ Photo uploaded</div>
                        </div>
                        <div class="upload-hint">Max 2MB â€¢ JPEG, PNG or WebP</div>
                    </div>
                </div>

                <button type="submit" id="joinBtn" class="btn btn-primary btn-large" style="width: 100%;" disabled>
                    Join Game
                </button>
            </form>
            
            <!-- Show debug toggle -->
            <p style="text-align: center; margin-top: 16px;">
                <a href="#" id="toggleDebug" style="font-size: 0.75rem; color: var(--text-light);">Hide debug info</a>
            </p>
        </div>

        <!-- Waiting State (shown after joining, in lobby) -->
        <div id="waitingCard" class="card phone-card" style="display: none;">
            <div style="text-align: center;">
                <h2 style="margin-bottom: 8px;">You're in! ðŸŽ‰</h2>
                <p style="color: var(--text-light); margin-bottom: 24px;">Waiting for the host to start the game...</p>
                
                <div class="player-avatar" style="width: 80px; height: 80px; font-size: 2rem; margin: 0 auto 16px;">
                    <span id="playerInitials">??</span>
                </div>
                
                <p style="font-size: 1.25rem; font-weight: 600;" id="playerName">-</p>
                <p style="color: var(--text-light);">Room: <strong id="roomCodeDisplay">----</strong></p>
                
                <div style="margin-top: 24px;">
                    <p style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 8px;">
                        Players in lobby:
                    </p>
                    <div id="playerCountBadge" style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">
                        0
                    </div>
                </div>

                <button id="leaveBtn" class="btn btn-secondary" style="margin-top: 24px;">
                    Leave Room
                </button>
            </div>
        </div>

        <!-- Game Active State (shown when game has started) -->
        <div id="gameActiveCard" class="card phone-card" style="display: none;">
            <div class="game-active-icon">ðŸŽ¯</div>
            <div class="game-active-title">Game Started!</div>
            <div class="game-active-subtitle">Get ready for the next question...</div>
            
            <div class="game-phase-badge" id="currentPhase">Starting</div>
            
            <div style="margin-top: 32px; padding: 16px; background: var(--bg-color); border-radius: 12px;">
                <p style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 4px;">Playing as</p>
                <p style="font-weight: 600; font-size: 1.125rem;" id="gamePlayerName">-</p>
            </div>
            
            <p style="margin-top: 24px; color: var(--text-light); font-size: 0.875rem;">
                Room: <strong id="gameRoomCode">----</strong>
            </p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/js/config.js"></script>
    <script src="/js/game-client.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script>
        // ===========================================
        // DOM Elements - declare ALL elements first
        // ===========================================
        const debugInfo = document.getElementById('debugInfo');
        const debugServerUrl = document.getElementById('debugServerUrl');
        const debugStatus = document.getElementById('debugStatus');
        const toggleDebug = document.getElementById('toggleDebug');
        const errorMessage = document.getElementById('errorMessage');
        const connectionStatus = document.getElementById('connectionStatus');
        const statusText = document.getElementById('statusText');
        const joinForm = document.getElementById('joinForm');
        const roomCodeInput = document.getElementById('roomCode');
        const displayNameInput = document.getElementById('displayName');
        const joinBtn = document.getElementById('joinBtn');
        const waitingCard = document.getElementById('waitingCard');
        const playerInitials = document.getElementById('playerInitials');
        const playerNameEl = document.getElementById('playerName');
        const roomCodeDisplay = document.getElementById('roomCodeDisplay');
        const playerCountBadge = document.getElementById('playerCountBadge');
        const leaveBtn = document.getElementById('leaveBtn');
        const gameActiveCard = document.getElementById('gameActiveCard');
        const currentPhase = document.getElementById('currentPhase');
        const gamePlayerName = document.getElementById('gamePlayerName');
        const gameRoomCode = document.getElementById('gameRoomCode');
        const avatarGrid = document.getElementById('avatarGrid');
        const avatarUpload = document.getElementById('avatarUpload');
        const uploadPreview = document.getElementById('uploadPreview');
        const uploadPreviewImg = document.getElementById('uploadPreviewImg');

        // ===========================================
        // State variables
        // ===========================================
        let client = null;
        let playerId = null;
        let hasJoined = false;
        let currentRoomStatus = 'Lobby';
        let selectedAvatarId = null;
        let avatarManifest = null;
        let uploadedAvatarFile = null;
        let uploadedAvatarUrl = null;
        
        // Get server URL
        const SERVER_URL = GameConfig.getServerUrl();
        debugServerUrl.textContent = SERVER_URL || '(same origin)';
        
        // ===========================================
        // Helper functions
        // ===========================================
        async function loadAvatarManifest() {
            try {
                const response = await fetch('/assets/avatars/manifest.json');
                if (!response.ok) {
                    throw new Error('Failed to load avatar manifest');
                }
                avatarManifest = await response.json();
                renderAvatarGrid();
            } catch (error) {
                console.error('Failed to load avatars:', error);
                document.getElementById('avatarGrid').innerHTML = '<div class="avatar-loading">Avatars not available</div>';
            }
        }

        function renderAvatarGrid() {
            const avatarGrid = document.getElementById('avatarGrid');
            if (!avatarManifest || !avatarManifest.packs || avatarManifest.packs.length === 0) {
                avatarGrid.innerHTML = '<div class="avatar-loading">No avatars available</div>';
                return;
            }

            const pack = avatarManifest.packs[0]; // Use first pack (jelly)
            avatarGrid.innerHTML = '';

            pack.items.forEach(avatar => {
                const option = document.createElement('div');
                option.className = 'avatar-option';
                option.dataset.avatarId = avatar.id;
                
                // Try to load image, fallback to emoji
                const img = document.createElement('img');
                img.src = avatar.src;
                img.alt = avatar.id;
                img.onerror = () => {
                    // Fallback to emoji placeholder if image fails to load
                    const placeholder = document.createElement('div');
                    placeholder.className = 'avatar-placeholder';
                    placeholder.textContent = getAvatarEmoji(avatar.id);
                    option.innerHTML = '';
                    option.appendChild(placeholder);
                };
                option.appendChild(img);

                option.addEventListener('click', () => selectAvatar(avatar.id));
                avatarGrid.appendChild(option);
            });

            // Auto-select first avatar or previously selected
            const storedAvatar = localStorage.getItem('partyGame_avatarPresetId');
            const firstAvatar = pack.items[0].id;
            selectAvatar(storedAvatar && pack.items.some(a => a.id === storedAvatar) ? storedAvatar : firstAvatar);
        }

        function selectAvatar(avatarId) {
            selectedAvatarId = avatarId;
            
            // Update UI
            document.querySelectorAll('.avatar-option').forEach(option => {
                if (option.dataset.avatarId === avatarId) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }

        function getAvatarEmoji(avatarId) {
            // Simple emoji mapping for jelly avatars
            const emojiMap = {
                'jelly_01': 'ðŸŸ£',
                'jelly_02': 'ðŸ”µ',
                'jelly_03': 'ðŸŸ¢',
                'jelly_04': 'ðŸŸ¡',
                'jelly_05': 'ðŸ”´',
                'jelly_06': 'ðŸŸ '
            };
            return emojiMap[avatarId] || 'â­';
        }

        function updateDebug(message) {
            console.log('[DEBUG]', message);
            debugStatus.textContent = message;
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('visible');
        }
        
        function hideError() {
            errorMessage.classList.remove('visible');
        }
        
        function getRoomCodeFromUrl() {
            const path = window.location.pathname;
            const match = path.match(/\/join\/([A-Za-z0-9]{4})/);
            return match ? match[1].toUpperCase() : null;
        }

        function loadAvatars() {
            // For now, use placeholder avatars - later we will load from server
            const placeholderAvatars = [
                'https://ui-avatars.com/api/?name=Avatar1&background=random',
                'https://ui-avatars.com/api/?name=Avatar2&background=random',
                'https://ui-avatars.com/api/?name=Avatar3&background=random',
                'https://ui-avatars.com/api/?name=Avatar4&background=random',
            ];
            
            placeholderAvatars.forEach((src, index) => {
                const avatarEl = document.createElement('div');
                avatarEl.className = 'avatar-item';
                avatarEl.dataset.value = `Avatar${index+1}`;
                avatarEl.innerHTML = `<img src="${src}" class="avatar-image" alt="Avatar ${index+1}">`;
                
                // Select handler
                avatarEl.addEventListener('click', () => {
                    document.querySelectorAll('.avatar-item').forEach(item => item.classList.remove('selected'));
                    avatarEl.classList.add('selected');
                    selectedAvatar = avatarEl.dataset.value;
                    updateDebug('Selected avatar: ' + selectedAvatar);
                });
                
                avatarGrid.appendChild(avatarEl);
            });
        }

        // ===========================================
        // Event handlers
        // ===========================================
        function onConnected() {
            connectionStatus.className = 'status status-connected';
            statusText.textContent = 'Connected';
            joinBtn.disabled = false;
            updateDebug('Connected and ready!');
        }

        function onDisconnected() {
            connectionStatus.className = 'status status-disconnected';
            statusText.textContent = 'Disconnected';
            updateDebug('Disconnected');
        }

        function onReconnecting() {
            connectionStatus.className = 'status status-connecting';
            statusText.textContent = 'Reconnecting...';
            updateDebug('Reconnecting...');
        }

        function onLobbyUpdated(roomState) {
            console.log('Lobby updated:', roomState);
            updateDebug('Lobby updated - ' + (roomState.players?.length || 0) + ' players');
            
            currentRoomStatus = roomState.status;
            
            if (!hasJoined) {
                hasJoined = true;
            }
            
            // Check if game is in progress - navigate to quiz phone view
            const isInGame = roomState.status === 'InGame' || roomState.status === 1;
            if (isInGame && roomState.currentGame) {
                if (roomState.currentGame.gameType === 'Quiz') {
                    const roomCode = roomState.roomCode;
                    window.location.href = `/quiz-phone.html?room=${roomCode}&playerId=${playerId}`;
                    return;
                }
            }
            
            // Show appropriate state based on game status
            if (isInGame) {
                showGameActiveState(roomState);
            } else {
                showWaitingState(roomState);
            }

            const players = roomState.players || [];
            playerCountBadge.textContent = players.length;
            hideError();
        }

        function onError(error) {
            updateDebug('Server error: ' + (error.code || error.message || error));
            showError(GameUtils.formatError(error));
            joinBtn.disabled = false;
            joinBtn.textContent = 'Join Game';
        }

        function showWaitingState(roomState) {
            const name = displayNameInput.value.trim() || GameUtils.getStoredName();
            
            joinForm.parentElement.style.display = 'none';
            waitingCard.style.display = 'block';
            gameActiveCard.style.display = 'none';
            
            playerInitials.textContent = GameUtils.getInitials(name);
            playerNameEl.textContent = name;
            roomCodeDisplay.textContent = roomState.roomCode;
            
            const players = roomState.players || [];
            playerCountBadge.textContent = players.length;
        }

        function showGameActiveState(roomState) {
            const name = displayNameInput.value.trim() || GameUtils.getStoredName();
            
            joinForm.parentElement.style.display = 'none';
            waitingCard.style.display = 'none';
            gameActiveCard.style.display = 'block';
            
            gamePlayerName.textContent = name;
            gameRoomCode.textContent = roomState.roomCode;
            
            // Update phase if available
            if (roomState.currentGame) {
                currentPhase.textContent = roomState.currentGame.phase || 'Starting';
            }
        }

        // Also handle GameStarted event
        function onGameStarted(gameSession) {
            console.log('Game started event:', gameSession);
            updateDebug('Game started: ' + gameSession.phase);
            
            // Navigate to quiz phone view
            if (gameSession.gameType === 'Quiz') {
                const roomCode = roomCodeInput.value.trim().toUpperCase() || GameUtils.getStoredRoomCode();
                window.location.href = `/quiz-phone.html?room=${roomCode}&playerId=${playerId}`;
            }
        }

        // ===========================================
        // Main initialization
        // ===========================================
        async function initApp() {
            updateDebug('Initializing...');
            
            try {
                // Load avatar manifest first
                await loadAvatarManifest();

                // Check if SignalR is loaded
                if (typeof signalR === 'undefined') {
                    updateDebug('ERROR: SignalR not loaded!');
                    showError('Failed to load SignalR library. Check your internet connection.');
                    return;
                }
                updateDebug('SignalR library loaded OK');

                // Pre-fill room code from URL
                const urlRoomCode = getRoomCodeFromUrl();
                if (urlRoomCode) {
                    roomCodeInput.value = urlRoomCode;
                    updateDebug('Room code from URL: ' + urlRoomCode);
                }

                // Pre-fill stored name
                const storedName = GameUtils.getStoredName();
                if (storedName) {
                    displayNameInput.value = storedName;
                }

                // Get player ID
                playerId = GameUtils.getPlayerId();
                updateDebug('Player ID: ' + playerId.substring(0, 8) + '...');

                // Test server connection first
                updateDebug('Testing server...');
                const testResult = await GameConfig.testServerConnection();
                
                if (!testResult.success) {
                    updateDebug('Server FAILED: ' + testResult.error);
                    showError('Cannot reach server: ' + testResult.error);
                    return;
                }
                
                updateDebug('Server OK! Connecting SignalR...');

                // Create client and set up callbacks
                client = new GameClient(SERVER_URL);
                client.on('onConnected', onConnected);
                client.on('onDisconnected', onDisconnected);
                client.on('onReconnecting', onReconnecting);
                client.on('onLobbyUpdated', onLobbyUpdated);
                client.on('onGameStarted', onGameStarted);
                client.on('onError', onError);

                // Connect
                await client.connect();
                updateDebug('SignalR connected!');
                
            } catch (error) {
                console.error('Init failed:', error);
                updateDebug('ERROR: ' + (error.message || String(error)));
                showError('Connection failed: ' + (error.message || String(error)));
            }
        }

        // ===========================================
        // UI Event listeners
        // ===========================================
        
        // Toggle debug info
        toggleDebug.addEventListener('click', (e) => {
            e.preventDefault();
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
            toggleDebug.textContent = debugInfo.style.display === 'none' ? 'Show debug info' : 'Hide debug info';
        });

        // Form submission
        joinForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const roomCode = roomCodeInput.value.trim().toUpperCase();
            const displayName = displayNameInput.value.trim();

            if (roomCode.length !== 4) {
                showError('Please enter a 4-character room code.');
                return;
            }

            if (!displayName || displayName.length > 20) {
                showError('Please enter a name (1-20 characters).');
                return;
            }

            hideError();
            joinBtn.disabled = true;
            joinBtn.textContent = 'Joining...';
            updateDebug('Joining room ' + roomCode + ' with avatar ' + (selectedAvatarId || uploadedAvatarFile?.name || 'none') + '...');

            try {
                // First, join the room
                await client.joinRoom(roomCode, playerId, displayName, selectedAvatarId);
                GameUtils.setStoredRoomCode(roomCode);
                
                // Then, if we have an uploaded file, upload it
                if (uploadedAvatarFile) {
                    joinBtn.textContent = 'Uploading photo...';
                    await uploadAvatar(roomCode, playerId);
                }
            } catch (error) {
                console.error('Join failed:', error);
                console.error('Error details:', {
                    roomCode,
                    playerId,
                    displayName,
                    selectedAvatarId,
                    hasUploadedFile: !!uploadedAvatarFile,
                    errorMessage: error.message,
                    errorStack: error.stack
                });
                updateDebug('Join failed: ' + (error.message || error));
                showError('Failed to join room. Please try again.');
                joinBtn.disabled = false;
                joinBtn.textContent = 'Join Game';
            }
        });

        // Leave button
        leaveBtn.addEventListener('click', async () => {
            try {
                await client.leaveRoom();
            } catch (error) {
                console.error('Leave failed:', error);
            }
            
            hasJoined = false;
            waitingCard.style.display = 'none';
            joinForm.parentElement.style.display = 'block';
            joinBtn.disabled = false;
            joinBtn.textContent = 'Join Game';
            GameUtils.setStoredRoomCode(null);
            updateDebug('Left room');
        });

        // Auto-uppercase room code input
        roomCodeInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase();
        });

        // Avatar upload handler
        document.getElementById('avatarUpload').addEventListener('change', async (e) => {
            const file = e.target.files?.[0];
            if (!file) return;

            // Validate file
            if (file.size > 2 * 1024 * 1024) {
                showError('Image file is too large. Maximum size is 2MB.');
                e.target.value = '';
                return;
            }

            const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                showError('Invalid file type. Please upload a JPEG, PNG, or WebP image.');
                e.target.value = '';
                return;
            }

            // Store file for upload after joining
            uploadedAvatarFile = file;

            // Show preview
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = document.getElementById('uploadPreviewImg');
                img.src = event.target.result;
                document.getElementById('uploadPreview').classList.add('visible');
                
                // Deselect preset avatars
                document.querySelectorAll('.avatar-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                selectedAvatarId = null;
                
                updateDebug('Photo selected for upload: ' + file.name);
            };
            reader.readAsDataURL(file);
        });

        /**
         * Upload avatar after joining room
         */
        async function uploadAvatar(roomCode, playerId) {
            if (!uploadedAvatarFile) return null;

            updateDebug('Uploading avatar...');
            
            const formData = new FormData();
            formData.append('file', uploadedAvatarFile);

            try {
                const response = await fetch(
                    (SERVER_URL || '') + `/api/rooms/${roomCode}/players/${playerId}/avatar`,
                    {
                        method: 'POST',
                        body: formData
                    }
                );

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Upload failed');
                }

                const data = await response.json();
                uploadedAvatarUrl = data.avatarUrl;
                updateDebug('Avatar uploaded: ' + data.avatarUrl);
                return data.avatarUrl;
            } catch (error) {
                console.error('Avatar upload failed:', error);
                updateDebug('Avatar upload failed: ' + error.message);
                // Don't fail the join, just log the error
                return null;
            }
        }

        // ===========================================
        // Start the app when DOM is ready
        // ===========================================
        updateDebug('Scripts loaded, starting...');
        initApp();
    </script>
</body>
</html>
