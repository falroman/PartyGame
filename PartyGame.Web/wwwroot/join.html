<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PartyGame - Join</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div class="phone-layout">
        <div class="card phone-card">
            <h1 style="text-align: center; margin-bottom: 8px;">ðŸŽ® PartyGame</h1>
            <p style="text-align: center; color: var(--text-light); margin-bottom: 24px;">Join the fun!</p>

            <!-- Connection Status -->
            <div id="connectionStatus" class="status status-connecting" style="margin-bottom: 16px;">
                <span class="status-dot"></span>
                <span id="statusText">Connecting...</span>
            </div>

            <!-- Debug Info (helpful for troubleshooting) -->
            <div id="debugInfo" style="font-size: 0.75rem; color: var(--text-light); margin-bottom: 16px; padding: 8px; background: var(--bg-color); border-radius: 4px;">
                <div>Server: <span id="debugServerUrl">-</span></div>
                <div>Status: <span id="debugStatus">Loading scripts...</span></div>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="error-message"></div>

            <!-- Join Form -->
            <form id="joinForm">
                <div class="input-group">
                    <label for="roomCode">Room Code</label>
                    <input 
                        type="text" 
                        id="roomCode" 
                        class="input input-large" 
                        maxlength="4" 
                        placeholder="ABCD"
                        autocomplete="off"
                        autocapitalize="characters"
                        required
                    >
                </div>

                <div class="input-group">
                    <label for="displayName">Your Name</label>
                    <input 
                        type="text" 
                        id="displayName" 
                        class="input" 
                        maxlength="20" 
                        placeholder="Enter your name"
                        autocomplete="off"
                        required
                    >
                </div>

                <button type="submit" id="joinBtn" class="btn btn-primary btn-large" style="width: 100%;" disabled>
                    Join Game
                </button>
            </form>
            
            <!-- Show debug toggle -->
            <p style="text-align: center; margin-top: 16px;">
                <a href="#" id="toggleDebug" style="font-size: 0.75rem; color: var(--text-light);">Hide debug info</a>
            </p>
        </div>

        <!-- Waiting State (shown after joining) -->
        <div id="waitingCard" class="card phone-card" style="display: none;">
            <div style="text-align: center;">
                <h2 style="margin-bottom: 8px;">You're in! ðŸŽ‰</h2>
                <p style="color: var(--text-light); margin-bottom: 24px;">Waiting for the host to start the game...</p>
                
                <div class="player-avatar" style="width: 80px; height: 80px; font-size: 2rem; margin: 0 auto 16px;">
                    <span id="playerInitials">??</span>
                </div>
                
                <p style="font-size: 1.25rem; font-weight: 600;" id="playerName">-</p>
                <p style="color: var(--text-light);">Room: <strong id="roomCodeDisplay">----</strong></p>
                
                <div style="margin-top: 24px;">
                    <p style="color: var(--text-light); font-size: 0.875rem; margin-bottom: 8px;">
                        Players in lobby:
                    </p>
                    <div id="playerCountBadge" style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">
                        0
                    </div>
                </div>

                <button id="leaveBtn" class="btn btn-secondary" style="margin-top: 24px;">
                    Leave Room
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/js/config.js"></script>
    <script src="/js/game-client.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script>
        // ===========================================
        // DOM Elements - declare ALL elements first
        // ===========================================
        const debugInfo = document.getElementById('debugInfo');
        const debugServerUrl = document.getElementById('debugServerUrl');
        const debugStatus = document.getElementById('debugStatus');
        const toggleDebug = document.getElementById('toggleDebug');
        const errorMessage = document.getElementById('errorMessage');
        const connectionStatus = document.getElementById('connectionStatus');
        const statusText = document.getElementById('statusText');
        const joinForm = document.getElementById('joinForm');
        const roomCodeInput = document.getElementById('roomCode');
        const displayNameInput = document.getElementById('displayName');
        const joinBtn = document.getElementById('joinBtn');
        const waitingCard = document.getElementById('waitingCard');
        const playerInitials = document.getElementById('playerInitials');
        const playerNameEl = document.getElementById('playerName');
        const roomCodeDisplay = document.getElementById('roomCodeDisplay');
        const playerCountBadge = document.getElementById('playerCountBadge');
        const leaveBtn = document.getElementById('leaveBtn');

        // ===========================================
        // State variables
        // ===========================================
        let client = null;
        let playerId = null;
        let hasJoined = false;
        
        // Get server URL
        const SERVER_URL = GameConfig.getServerUrl();
        debugServerUrl.textContent = SERVER_URL || '(same origin)';
        
        // ===========================================
        // Helper functions
        // ===========================================
        function updateDebug(message) {
            console.log('[DEBUG]', message);
            debugStatus.textContent = message;
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('visible');
        }
        
        function hideError() {
            errorMessage.classList.remove('visible');
        }
        
        function getRoomCodeFromUrl() {
            const path = window.location.pathname;
            const match = path.match(/\/join\/([A-Za-z0-9]{4})/);
            return match ? match[1].toUpperCase() : null;
        }

        // ===========================================
        // Event handlers
        // ===========================================
        function onConnected() {
            connectionStatus.className = 'status status-connected';
            statusText.textContent = 'Connected';
            joinBtn.disabled = false;
            updateDebug('Connected and ready!');
        }

        function onDisconnected() {
            connectionStatus.className = 'status status-disconnected';
            statusText.textContent = 'Disconnected';
            updateDebug('Disconnected');
        }

        function onReconnecting() {
            connectionStatus.className = 'status status-connecting';
            statusText.textContent = 'Reconnecting...';
            updateDebug('Reconnecting...');
        }

        function onLobbyUpdated(roomState) {
            console.log('Lobby updated:', roomState);
            updateDebug('Lobby updated - ' + (roomState.players?.length || 0) + ' players');
            
            if (!hasJoined) {
                hasJoined = true;
                showWaitingState(roomState);
            }

            const players = roomState.players || [];
            playerCountBadge.textContent = players.length;
            hideError();
        }

        function onError(error) {
            updateDebug('Server error: ' + (error.code || error.message || error));
            showError(GameUtils.formatError(error));
            joinBtn.disabled = false;
            joinBtn.textContent = 'Join Game';
        }

        function showWaitingState(roomState) {
            const name = displayNameInput.value.trim();
            
            joinForm.parentElement.style.display = 'none';
            waitingCard.style.display = 'block';
            
            playerInitials.textContent = GameUtils.getInitials(name);
            playerNameEl.textContent = name;
            roomCodeDisplay.textContent = roomState.roomCode;
            
            const players = roomState.players || [];
            playerCountBadge.textContent = players.length;
        }

        // ===========================================
        // Main initialization
        // ===========================================
        async function initApp() {
            updateDebug('Initializing...');
            
            try {
                // Check if SignalR is loaded
                if (typeof signalR === 'undefined') {
                    updateDebug('ERROR: SignalR not loaded!');
                    showError('Failed to load SignalR library. Check your internet connection.');
                    return;
                }
                updateDebug('SignalR library loaded OK');

                // Pre-fill room code from URL
                const urlRoomCode = getRoomCodeFromUrl();
                if (urlRoomCode) {
                    roomCodeInput.value = urlRoomCode;
                    updateDebug('Room code from URL: ' + urlRoomCode);
                }

                // Pre-fill stored name
                const storedName = GameUtils.getStoredName();
                if (storedName) {
                    displayNameInput.value = storedName;
                }

                // Get player ID
                playerId = GameUtils.getPlayerId();
                updateDebug('Player ID: ' + playerId.substring(0, 8) + '...');

                // Test server connection first
                updateDebug('Testing server...');
                const testResult = await GameConfig.testServerConnection();
                
                if (!testResult.success) {
                    updateDebug('Server FAILED: ' + testResult.error);
                    showError('Cannot reach server: ' + testResult.error);
                    return;
                }
                
                updateDebug('Server OK! Connecting SignalR...');

                // Create client and set up callbacks
                client = new GameClient(SERVER_URL);
                client.on('onConnected', onConnected);
                client.on('onDisconnected', onDisconnected);
                client.on('onReconnecting', onReconnecting);
                client.on('onLobbyUpdated', onLobbyUpdated);
                client.on('onError', onError);

                // Connect
                await client.connect();
                updateDebug('SignalR connected!');
                
            } catch (error) {
                console.error('Init failed:', error);
                updateDebug('ERROR: ' + (error.message || String(error)));
                showError('Connection failed: ' + (error.message || String(error)));
            }
        }

        // ===========================================
        // UI Event listeners
        // ===========================================
        
        // Toggle debug info
        toggleDebug.addEventListener('click', (e) => {
            e.preventDefault();
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
            toggleDebug.textContent = debugInfo.style.display === 'none' ? 'Show debug info' : 'Hide debug info';
        });

        // Form submission
        joinForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const roomCode = roomCodeInput.value.trim().toUpperCase();
            const displayName = displayNameInput.value.trim();

            if (roomCode.length !== 4) {
                showError('Please enter a 4-character room code.');
                return;
            }

            if (!displayName || displayName.length > 20) {
                showError('Please enter a name (1-20 characters).');
                return;
            }

            hideError();
            joinBtn.disabled = true;
            joinBtn.textContent = 'Joining...';
            updateDebug('Joining room ' + roomCode + '...');

            try {
                await client.joinRoom(roomCode, playerId, displayName);
                GameUtils.setStoredRoomCode(roomCode);
            } catch (error) {
                console.error('Join failed:', error);
                updateDebug('Join failed: ' + (error.message || error));
                showError('Failed to join room. Please try again.');
                joinBtn.disabled = false;
                joinBtn.textContent = 'Join Game';
            }
        });

        // Leave button
        leaveBtn.addEventListener('click', async () => {
            try {
                await client.leaveRoom();
            } catch (error) {
                console.error('Leave failed:', error);
            }
            
            hasJoined = false;
            waitingCard.style.display = 'none';
            joinForm.parentElement.style.display = 'block';
            joinBtn.disabled = false;
            joinBtn.textContent = 'Join Game';
            GameUtils.setStoredRoomCode(null);
            updateDebug('Left room');
        });

        // Auto-uppercase room code input
        roomCodeInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase();
        });

        // ===========================================
        // Start the app when DOM is ready
        // ===========================================
        updateDebug('Scripts loaded, starting...');
        initApp();
    </script>
</body>
</html>
