<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>PartyGame - Play</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .quiz-phone {
            max-width: 420px;
            margin: 0 auto;
            padding: 16px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .quiz-phone-header {
            background: rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            color: white;
            text-align: center;
        }

        .quiz-phone-header h2 {
            margin: 0 0 8px;
            font-size: 1.25rem;
        }

        .timer-display {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .timer-display.warning {
            color: #f1c40f;
            animation: blink 0.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .phase-indicator {
            font-size: 0.875rem;
            opacity: 0.8;
            margin-top: 4px;
        }

        /* Question Card */
        .question-card-phone {
            background: white;
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 16px;
            flex-shrink: 0;
        }

        .question-number {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-bottom: 8px;
        }

        .question-text-phone {
            font-size: 1.125rem;
            font-weight: 600;
            line-height: 1.4;
        }

        /* Answer Buttons */
        .answer-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            flex: 1;
        }

        .answer-btn {
            border: none;
            border-radius: 16px;
            padding: 20px;
            font-size: 1.25rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            min-height: 120px;
        }

        .answer-btn:active {
            transform: scale(0.95);
        }

        .answer-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .answer-btn.a { background: #e74c3c; }
        .answer-btn.b { background: #3498db; }
        .answer-btn.c { background: #f1c40f; color: #333; }
        .answer-btn.d { background: #2ecc71; }

        .answer-btn.selected {
            box-shadow: 0 0 0 4px white, 0 0 0 8px currentColor;
        }

        .answer-btn.correct {
            background: #27ae60 !important;
            color: white !important;
        }

        .answer-btn.incorrect {
            background: #95a5a6 !important;
        }

        .answer-key {
            font-size: 2rem;
        }

        .answer-text {
            font-size: 0.875rem;
            text-align: center;
            line-height: 1.2;
        }

        /* Waiting State */
        .waiting-state {
            background: white;
            border-radius: 20px;
            padding: 40px 24px;
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .waiting-icon {
            font-size: 4rem;
            margin-bottom: 16px;
        }

        .waiting-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .waiting-subtitle {
            color: var(--text-light);
        }

        /* Result State */
        .result-state {
            background: white;
            border-radius: 20px;
            padding: 32px 24px;
            text-align: center;
        }

        .result-icon {
            font-size: 5rem;
            margin-bottom: 16px;
        }

        .result-text {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .result-points {
            font-size: 1.125rem;
            color: var(--text-light);
        }

        .result-points.positive {
            color: var(--success-color);
        }

        /* Scoreboard Phone */
        .scoreboard-phone {
            background: white;
            border-radius: 20px;
            padding: 24px;
            flex: 1;
        }

        .scoreboard-phone-title {
            text-align: center;
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 16px;
        }

        .score-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            background: var(--bg-color);
        }

        .score-item.me {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .score-position {
            font-weight: bold;
            width: 32px;
        }

        .score-name {
            flex: 1;
            font-weight: 500;
        }

        .score-value {
            font-weight: bold;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="quiz-phone">
        <!-- Header -->
        <div class="quiz-phone-header">
            <h2>Quiz Time! ??</h2>
            <div class="timer-display" id="timer">15</div>
            <div class="phase-indicator" id="phaseIndicator">Get ready...</div>
        </div>

        <!-- Question Display -->
        <div class="question-card-phone" id="questionCard">
            <div class="question-number" id="questionNumber">Question 1 of 10</div>
            <div class="question-text-phone" id="questionText">Loading...</div>
        </div>

        <!-- Answer Buttons (shown during Answering phase) -->
        <div class="answer-buttons" id="answerButtons">
            <button class="answer-btn a" data-key="A">
                <span class="answer-key">A</span>
                <span class="answer-text" id="optionA">...</span>
            </button>
            <button class="answer-btn b" data-key="B">
                <span class="answer-key">B</span>
                <span class="answer-text" id="optionB">...</span>
            </button>
            <button class="answer-btn c" data-key="C">
                <span class="answer-key">C</span>
                <span class="answer-text" id="optionC">...</span>
            </button>
            <button class="answer-btn d" data-key="D">
                <span class="answer-key">D</span>
                <span class="answer-text" id="optionD">...</span>
            </button>
        </div>

        <!-- Waiting State (shown during Question phase) -->
        <div class="waiting-state hidden" id="waitingState">
            <div class="waiting-icon">??</div>
            <div class="waiting-title">Watch the screen!</div>
            <div class="waiting-subtitle">Get ready to answer...</div>
        </div>

        <!-- Answer Submitted State -->
        <div class="waiting-state hidden" id="submittedState">
            <div class="waiting-icon">?</div>
            <div class="waiting-title">Answer Received!</div>
            <div class="waiting-subtitle">Waiting for other players...</div>
        </div>

        <!-- Result State (shown during Reveal) -->
        <div class="result-state hidden" id="resultState">
            <div class="result-icon" id="resultIcon">?</div>
            <div class="result-text" id="resultText">Correct!</div>
            <div class="result-points" id="resultPoints">+100 points</div>
        </div>

        <!-- Scoreboard (shown during Scoreboard phase) -->
        <div class="scoreboard-phone hidden" id="scoreboardState">
            <div class="scoreboard-phone-title" id="scoreboardTitle">?? Scores</div>
            <div id="scoreboardList"></div>
        </div>

        <!-- Game Finished -->
        <div class="waiting-state hidden" id="finishedState">
            <div class="waiting-icon">??</div>
            <div class="waiting-title" id="finishedTitle">Game Over!</div>
            <div class="waiting-subtitle" id="finishedSubtitle">Thanks for playing!</div>
            <button class="btn btn-primary" style="margin-top: 24px;" onclick="window.location.href='/join.html'">
                Play Again
            </button>
        </div>
    </div>

    <!-- SignalR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script src="/js/config.js"></script>
    <script src="/js/game-client.js"></script>
    <script>
        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const roomCode = urlParams.get('room');
        const playerIdParam = urlParams.get('playerId');

        if (!roomCode) {
            window.location.href = '/join.html';
        }

        const SERVER_URL = GameConfig.getServerUrl();
        const client = new GameClient(SERVER_URL);
        const playerId = playerIdParam || GameUtils.getPlayerId();
        const displayName = GameUtils.getStoredName() || 'Player';

        // State
        let selectedAnswer = null;
        let currentPhase = null;
        let myScore = 0;

        // DOM Elements
        const timerEl = document.getElementById('timer');
        const phaseIndicatorEl = document.getElementById('phaseIndicator');
        const questionCardEl = document.getElementById('questionCard');
        const questionNumberEl = document.getElementById('questionNumber');
        const questionTextEl = document.getElementById('questionText');
        const answerButtonsEl = document.getElementById('answerButtons');
        const waitingStateEl = document.getElementById('waitingState');
        const submittedStateEl = document.getElementById('submittedState');
        const resultStateEl = document.getElementById('resultState');
        const resultIconEl = document.getElementById('resultIcon');
        const resultTextEl = document.getElementById('resultText');
        const resultPointsEl = document.getElementById('resultPoints');
        const scoreboardStateEl = document.getElementById('scoreboardState');
        const scoreboardTitleEl = document.getElementById('scoreboardTitle');
        const scoreboardListEl = document.getElementById('scoreboardList');
        const finishedStateEl = document.getElementById('finishedState');
        const finishedTitleEl = document.getElementById('finishedTitle');
        const finishedSubtitleEl = document.getElementById('finishedSubtitle');

        // Answer buttons
        const answerBtns = document.querySelectorAll('.answer-btn');
        answerBtns.forEach(btn => {
            btn.addEventListener('click', () => submitAnswer(btn.dataset.key));
        });

        // Initialize
        async function init() {
            client.on('onConnected', () => console.log('Connected'));
            client.on('onQuizStateUpdated', onQuizStateUpdated);
            client.on('onError', (error) => {
                console.error('Error:', error);
                alert(GameUtils.formatError(error));
            });

            await client.connect();
            await client.joinRoom(roomCode, playerId, displayName);
        }

        function onQuizStateUpdated(state) {
            console.log('Quiz state:', state);

            // Update timer
            timerEl.textContent = state.remainingSeconds;
            timerEl.classList.toggle('warning', state.remainingSeconds <= 5);

            // Get phase
            const phase = typeof state.phase === 'number' ? state.phase :
                ['Question', 'Answering', 'Reveal', 'Scoreboard', 'Finished'].indexOf(state.phase);
            currentPhase = phase;

            // Update phase indicator
            const phaseNames = ['Reading question...', 'Answer now!', 'Revealing answer...', 'Scoreboard', 'Game Over'];
            phaseIndicatorEl.textContent = phaseNames[phase] || state.phase;

            // Update question info
            questionNumberEl.textContent = `Question ${state.questionNumber} of ${state.totalQuestions}`;
            questionTextEl.textContent = state.questionText;

            // Update options
            state.options.forEach(opt => {
                const el = document.getElementById('option' + opt.key);
                if (el) el.textContent = opt.text;
            });

            // Find my status
            const myStatus = state.answerStatuses.find(s => s.playerId === playerId);
            const myScoreData = state.scoreboard.find(s => s.playerId === playerId);
            if (myScoreData) myScore = myScoreData.score;

            // Handle different phases
            if (phase === 4) { // Finished
                showFinished(state);
            } else if (phase === 3) { // Scoreboard
                showScoreboard(state);
            } else if (phase === 2) { // Reveal
                showReveal(state, myScoreData);
            } else if (phase === 1) { // Answering
                if (myStatus?.hasAnswered) {
                    showSubmitted();
                } else {
                    showAnswering(state);
                }
            } else { // Question
                showWaiting();
            }
        }

        function showWaiting() {
            hideAll();
            questionCardEl.classList.remove('hidden');
            waitingStateEl.classList.remove('hidden');
            selectedAnswer = null;
        }

        function showAnswering(state) {
            hideAll();
            questionCardEl.classList.remove('hidden');
            answerButtonsEl.classList.remove('hidden');

            // Reset button states
            answerBtns.forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('selected', 'correct', 'incorrect');
            });
            selectedAnswer = null;
        }

        function showSubmitted() {
            hideAll();
            questionCardEl.classList.remove('hidden');
            submittedStateEl.classList.remove('hidden');
        }

        function showReveal(state, myScoreData) {
            hideAll();
            questionCardEl.classList.remove('hidden');
            resultStateEl.classList.remove('hidden');

            const wasCorrect = myScoreData?.answeredCorrectly === true;
            resultIconEl.textContent = wasCorrect ? '?' : '?';
            resultTextEl.textContent = wasCorrect ? 'Correct!' : 'Wrong!';
            resultPointsEl.textContent = wasCorrect ? '+100 points' : '+0 points';
            resultPointsEl.classList.toggle('positive', wasCorrect);

            // Show correct answer in question card
            // Update buttons to show correct/incorrect
            answerButtonsEl.classList.remove('hidden');
            answerBtns.forEach(btn => {
                btn.disabled = true;
                const key = btn.dataset.key;
                btn.classList.remove('selected');
                
                if (key === state.correctOptionKey) {
                    btn.classList.add('correct');
                } else if (key === myScoreData?.selectedOption) {
                    btn.classList.add('incorrect');
                }
            });
        }

        function showScoreboard(state) {
            hideAll();
            scoreboardStateEl.classList.remove('hidden');

            scoreboardTitleEl.textContent = state.questionNumber >= state.totalQuestions 
                ? '?? Final Scores' : '?? Scores';

            scoreboardListEl.innerHTML = state.scoreboard.map(player => {
                const isMe = player.playerId === playerId;
                const emoji = player.position === 1 ? '??' : 
                             player.position === 2 ? '??' : 
                             player.position === 3 ? '??' : `#${player.position}`;

                return `
                    <div class="score-item ${isMe ? 'me' : ''}">
                        <div class="score-position">${emoji}</div>
                        <div class="score-name">${escapeHtml(player.displayName)}${isMe ? ' (You)' : ''}</div>
                        <div class="score-value">${player.score}</div>
                    </div>
                `;
            }).join('');
        }

        function showFinished(state) {
            hideAll();
            finishedStateEl.classList.remove('hidden');

            const myPosition = state.scoreboard.findIndex(s => s.playerId === playerId) + 1;
            const winner = state.scoreboard[0];

            if (myPosition === 1) {
                finishedTitleEl.textContent = '?? You Won!';
                finishedSubtitleEl.textContent = `${myScore} points`;
            } else {
                finishedTitleEl.textContent = `You finished #${myPosition}`;
                finishedSubtitleEl.textContent = `${myScore} points - Winner: ${winner?.displayName}`;
            }
        }

        function hideAll() {
            waitingStateEl.classList.add('hidden');
            submittedStateEl.classList.add('hidden');
            answerButtonsEl.classList.add('hidden');
            resultStateEl.classList.add('hidden');
            scoreboardStateEl.classList.add('hidden');
            finishedStateEl.classList.add('hidden');
        }

        async function submitAnswer(key) {
            if (selectedAnswer || currentPhase !== 1) return;

            selectedAnswer = key;
            
            // Visual feedback
            answerBtns.forEach(btn => {
                btn.disabled = true;
                if (btn.dataset.key === key) {
                    btn.classList.add('selected');
                }
            });

            try {
                await client.submitAnswer(key);
                showSubmitted();
            } catch (error) {
                console.error('Failed to submit answer:', error);
                selectedAnswer = null;
                answerBtns.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('selected');
                });
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Start
        init();
    </script>
</body>
</html>
